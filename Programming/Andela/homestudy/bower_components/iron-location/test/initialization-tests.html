<!DOCTYPE html><html><head><meta charset="utf-8"><title></title><script src="../../webcomponentsjs/webcomponents-lite.js"></script><script src="../../web-component-tester/browser.js"></script><script src="../../test-fixture/test-fixture-mocha.js"></script><link rel="import" href="../../polymer/polymer.html"><link rel="import" href="../../promise-polyfill/promise-polyfill.html"><link rel="import" href="../../test-fixture/test-fixture.html"><link rel="import" href="../iron-location.html"><link rel="import" href="./replace-state-patch.html"></head><body><div id="safari-cooldown" hidden=""><div>Danger: URL overheating.</div><div>Safari and Chrome require a cooldown period before we call pushState/replaceState any more.</div><div>Testing will resume after 30 seconds.</div><div><a href="https://forums.developer.apple.com/thread/36650">More info Safari</a> <a href="https://codereview.chromium.org/2972073002">Chrome</a></div></div><script>"use strict";window.addEventListener("WebComponentsReady",function(){function getIframe(){return new Promise(function(resolve,reject){var iframe=document.createElement("iframe"),result=getMessageMatching(iframe,function(message){return"ready"===message.type});iframe.src="./initialization-iframe.html";document.body.appendChild(iframe);iframe.addEventListener("error",reject);result.then(function(){resolve(iframe)},reject)})}function onMessage(iframe,callback){var f=function(event){if(event.source===iframe.contentWindow){callback(event.data)}};window.addEventListener("message",f,!1);return function(){window.removeEventListener("message",f)}}function getMessageMatching(iframe,predicate){var revoke=function(){},result=new Promise(function(resolve){revoke=onMessage(iframe,function(message){if(predicate(message)){resolve(message)}})});result.then(revoke,revoke);return result}function getUrl(iframe){var result=getMessageMatching(iframe,function(message){return"urlQueryResponse"===message.type}),revoke=function(){};result.then(function(){return new Promise(function(resolve){revoke=onMessage(iframe,resolve)})});result.then(revoke,revoke);iframe.contentWindow.postMessage({type:"urlQuery"},"*");return result}function timePasses(ms){return new Promise(function(resolve){window.setTimeout(function(){resolve()},ms)})}suite("<iron-location>'s initialization",function(){var iframe,error;setup(function(){return getIframe().then(function(i){iframe=i;getMessageMatching(iframe,function(m){return"error"===m.type}).then(function(m){error=m.error})}.bind(this)).then(function(){return cooldownFunction.call(this)}.bind(this))});teardown(function(){if(iframe){document.body.removeChild(iframe)}var e=error;iframe=null;error=null;if(e){throw new Error("Error message from contained iframe: "+e)}return cooldownFunction.call(this)});["default-before","attached-before","ready-before","default-above","attached-above","ready-above","default-container","attached-container"].forEach(function(caseName){test("the url takes priority in "+caseName+" initialization",function(){return getUrl(iframe).then(function(url){expect(url.search).to.be.eq("");iframe.contentWindow.postMessage({type:"appendBody",tagName:caseName},"*");return timePasses(60).then(function(){return getUrl(iframe)})}).then(function(url){expect(url.search).to.be.eq("")})})});["timeout-before","timeout-after","timeout-below","timeout-above","timeout-container"].forEach(function(caseName){test("the url does not take priority in "+caseName+" initialization",function(){return getUrl(iframe).then(function(url){expect(url.search).to.be.eq("");iframe.contentWindow.postMessage({type:"appendBody",tagName:caseName},"*");return timePasses(60).then(function(){return getUrl(iframe)})}).then(function(url){expect(url.search).to.be.eq("?on-timeout")})})})})});</script></body></html>